
name: Secure CI/CD

on:
  push:
    branches: [ release ]

jobs:
  verify:
    runs-on: ubuntu-latest
    env:
      SPRING_PROFILES_ACTIVE: test
      DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradlew', '**/settings.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run unit tests
        run: ./gradlew test --no-daemon

  build-and-push:
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: taehun2/bbb:${{ github.ref_name }}
          build-args: |
            SPRING_PROFILES_ACTIVE=prod
            DATABASE_NAME=${{ secrets.DATABASE_NAME }}
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            OAUTH_CLIENT_ID=${{ secrets.OAUTH_CLIENT_ID }}
            OAUTH_SECRET_KEY=${{ secrets.OAUTH_SECRET_KEY }}
            UNIV_API_KEY=${{ secrets.UNIV_API_KEY }}
            KAKAO_REST_API_KEY=${{ secrets.KAKAO_REST_API_KEY }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            OPENAI_API_URI=${{ secrets.OPENAI_API_URI }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            OPENAI_MODEL=${{ secrets.OPENAI_MODEL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Prepare deployment data and signature
        id: prepare
        run: |
          DEPLOY_JSON="{\"image\":\"taehun2/bbb:${{ github.ref_name }}\",\"env\":{\"SPRING_PROFILES_ACTIVE\":\"prod\",\"DATABASE_NAME\":\"${{ secrets.DATABASE_NAME }}\",\"MONGODB_URI\":\"${{ secrets.MONGODB_URI }}\",\"OAUTH_CLIENT_ID\":\"${{ secrets.OAUTH_CLIENT_ID }}\",\"OAUTH_SECRET_KEY\":\"${{ secrets.OAUTH_SECRET_KEY }}\",\"UNIV_API_KEY\":\"${{ secrets.UNIV_API_KEY }}\",\"KAKAO_REST_API_KEY\":\"${{ secrets.KAKAO_REST_API_KEY }}\",\"JWT_SECRET\":\"${{ secrets.JWT_SECRET }}\",\"OPENAI_API_URI\":\"${{ secrets.OPENAI_API_URI }}\",\"OPENAI_API_KEY\":\"${{ secrets.OPENAI_API_KEY }}\",\"OPENAI_MODEL\":\"${{ secrets.OPENAI_MODEL }}\"}}"
          SIGNATURE=$(echo -n "$DEPLOY_JSON" | openssl dgst -sha256 -hmac "${{ secrets.WEBHOOK_SECRET }}" | cut -d' ' -f2)
          echo "deploy_json=$DEPLOY_JSON" >> $GITHUB_OUTPUT
          echo "signature=$SIGNATURE" >> $GITHUB_OUTPUT

      - name: Trigger deployment
        run: |
          curl -X POST "${{ secrets.OFFICE_PC_WEBHOOK_URL }}/deploy" \
            -H "Content-Type: application/json" \
            -d '{
              "image": "taehun2/bbb:${{ github.ref_name }}",
              "env": {
                "SPRING_PROFILES_ACTIVE": "prod",
                "DATABASE_NAME": "${{ secrets.DATABASE_NAME}}",
                "MONGODB_URI": "${{ secrets.MONGODB_URI }}",
                "OAUTH_CLIENT_ID": "${{ secrets.OAUTH_CLIENT_ID }}",
                "OAUTH_SECRET_KEY": "${{ secrets.OAUTH_SECRET_KEY }}",
                "UNIV_API_KEY": "${{ secrets.UNIV_API_KEY }}",
                "KAKAO_REST_API_KEY": "${{ secrets.KAKAO_REST_API_KEY }}",
                "JWT_SECRET": "${{ secrets.JWT_SECRET }}",
                "OPENAI_API_URI": "${{ secrets.OPENAI_API_URI }}",
                "OPENAI_API_KEY": "${{ secrets.OPENAI_API_KEY }}",
                "OPENAI_MODEL": "${{ secrets.OPENAI_MODEL }}"
              }
            }'
            
      # ✅ SubServer 배포 (추가)
      - name: Deploy to SubServer
        run: |
          curl -X POST "${{ secrets.SUB_SERVER_WEBHOOK_URL }}/deploy" \
            -H "Content-Type: application/json" \
            -d '{
              "image": "taehun2/bbb:${{ github.ref_name }}",
              "env": {
                "SPRING_PROFILES_ACTIVE": "prod",
                "DATABASE_NAME": "${{ secrets.DATABASE_NAME}}",
                "MONGODB_URI": "${{ secrets.MONGODB_URI }}",
                "OAUTH_CLIENT_ID": "${{ secrets.OAUTH_CLIENT_ID }}",
                "OAUTH_SECRET_KEY": "${{ secrets.OAUTH_SECRET_KEY }}",
                "UNIV_API_KEY": "${{ secrets.UNIV_API_KEY }}",
                "KAKAO_REST_API_KEY": "${{ secrets.KAKAO_REST_API_KEY }}",
                "JWT_SECRET": "${{ secrets.JWT_SECRET }}",
                "OPENAI_API_URI": "${{ secrets.OPENAI_API_URI }}",
                "OPENAI_API_KEY": "${{ secrets.OPENAI_API_KEY }}",
                "OPENAI_MODEL": "${{ secrets.OPENAI_MODEL }}"
              }
            }'
      
