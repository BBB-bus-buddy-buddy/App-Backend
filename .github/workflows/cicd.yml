name: Secure CI/CD

on:
  push:
    branches: [ release ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 1) QEMU ì„¸íŒ… (ë©€í‹°ì•„ì¹˜ ë¹Œë“œ í•„ìš”)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 2) Buildx ì„¸íŒ…
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3) Docker Hub ë¡œê·¸ì¸
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # (ì„ íƒ) ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ìë™ ìƒì„±(ë²„ì „/ë¼ë²¨ ë“±)
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: taehun2/bbb
          tags: |
            type=raw,value=${{ github.ref_name }}   # e.g. "release"
            type=raw,value=latest                   # í•„ìš” ì‹œ latestë„ í•¨ê»˜ í‘¸ì‹œ
          labels: |
            org.opencontainers.image.source=${{ github.repository }}

      # 4) ë©€í‹°ì•„ì¹˜ ë¹Œë“œ & í‘¸ì‹œ (buildx)
      - name: Build and push Docker image (multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64         # ğŸ‘ˆ í•µì‹¬
          tags: ${{ steps.meta.outputs.tags }}       # ìœ„ metaì—ì„œ ë§Œë“  íƒœê·¸ë“¤
          labels: ${{ steps.meta.outputs.labels }}
          # ìºì‹œ (BuildKit + GHA)
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # (ì„ íƒ) SBOM/í”„ë¡œë¹„ë„ŒìŠ¤
          provenance: mode=max
          sbom: true
          # ë¹Œë“œ ì¸ì (ì •ë§ í•„ìš”í•œ ê²ƒë§Œ â€” ë¯¼ê°ì •ë³´ëŠ” ê°€ê¸‰ì  ë„£ì§€ ë§ˆì„¸ìš”)
          build-args: |
            SPRING_PROFILES_ACTIVE=prod

      # 5) ë°°í¬ ë°ì´í„°/ì„œëª… ì¤€ë¹„ (ì¶œë ¥ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
      - name: Prepare deployment data and signature
        id: prepare
        run: |
          DEPLOY_JSON="{\"image\":\"taehun2/bbb:${{ github.ref_name }}\",\"env\":{\"SPRING_PROFILES_ACTIVE\":\"prod\",\"DATABASE_NAME\":\"${{ secrets.DATABASE_NAME }}\",\"MONGODB_URI\":\"${{ secrets.MONGODB_URI }}\",\"OAUTH_CLIENT_ID\":\"${{ secrets.OAUTH_CLIENT_ID }}\",\"OAUTH_SECRET_KEY\":\"${{ secrets.OAUTH_SECRET_KEY }}\",\"UNIV_API_KEY\":\"${{ secrets.UNIV_API_KEY }}\",\"KAKAO_REST_API_KEY\":\"${{ secrets.KAKAO_REST_API_KEY }}\",\"JWT_SECRET\":\"${{ secrets.JWT_SECRET }}\"}}"
          SIGNATURE=$(echo -n "$DEPLOY_JSON" | openssl dgst -sha256 -hmac "${{ secrets.WEBHOOK_SECRET }}" | cut -d' ' -f2)
          echo "deploy_json=$DEPLOY_JSON" >> $GITHUB_OUTPUT
          echo "signature=$SIGNATURE" >> $GITHUB_OUTPUT

      # 6) ë°°í¬ íŠ¸ë¦¬ê±° (ì›¹í›…)
      - name: Trigger deployment
        run: |
          curl -X POST "${{ secrets.OFFICE_PC_WEBHOOK_URL }}/deploy" \
            -H "Content-Type: application/json" \
            -H "X-Signature: ${{ steps.prepare.outputs.signature }}" \
            -d '${{ steps.prepare.outputs.deploy_json }}'
