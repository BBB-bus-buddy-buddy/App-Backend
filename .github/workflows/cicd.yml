name: CI/CD

on:
  push:
    branches: [ release ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Debug build arguments
        run: |
          echo "SPRING_PROFILES_ACTIVE: prod"
          echo "DATABASE_NAME is set: ${{ secrets.DATABASE_NAME != '' }}"
          echo "MONGODB_URI is set: ${{ secrets.MONGODB_URI != '' }}"
          echo "OAUTH_CLIENT_ID is set: ${{ secrets.OAUTH_CLIENT_ID != '' }}"
          echo "OAUTH_SECRET_KEY is set: ${{ secrets.OAUTH_SECRET_KEY != '' }}"
          echo "UNIV_API_KEY is set: ${{ secrets.UNIV_API_KEY != '' }}"
          echo "KAKAO_REST_API_KEY is set: ${{ secrets.KAKAO_REST_API_KEY != '' }}"
          echo "JWT_SECRET is set: ${{ secrets.JWT_SECRET != '' }}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: taehun2/bbb:${{ github.ref_name }}
          build-args: |
            SPRING_PROFILES_ACTIVE=prod
            DATABASE_NAME=${{ secrets.DATABASE_NAME }}
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            OAUTH_CLIENT_ID=${{ secrets.OAUTH_CLIENT_ID }}
            OAUTH_SECRET_KEY=${{ secrets.OAUTH_SECRET_KEY }}
            UNIV_API_KEY=${{ secrets.UNIV_API_KEY }}
            KAKAO_REST_API_KEY=${{ secrets.KAKAO_REST_API_KEY }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
          outputs: type=docker,dest=/tmp/image.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Load image
        run: |
          docker load --input /tmp/image.tar
          docker image ls -a

      - name: Trigger deployment
        run: |
          curl -X POST ${{ secrets.OFFICE_PC_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d '{
            "image": "taehun2/bbb:${{ github.ref_name }}",
            "env": {
              "SPRING_PROFILES_ACTIVE": "prod",
              "DATABASE_NAME": "${{ secrets.DATABASE_NAME}}",
              "MONGODB_URI": "${{ secrets.MONGODB_URI }}",
              "OAUTH_CLIENT_ID": "${{ secrets.OAUTH_CLIENT_ID }}",
              "OAUTH_SECRET_KEY": "${{ secrets.OAUTH_SECRET_KEY }}",
              "UNIV_API_KEY": "${{ secrets.UNIV_API_KEY }}",
              "KAKAO_REST_API_KEY": "${{ secrets.KAKAO_REST_API_KEY }}",
              "JWT_SECRET": "${{ secrets.JWT_SECRET }}"
            }
          }'